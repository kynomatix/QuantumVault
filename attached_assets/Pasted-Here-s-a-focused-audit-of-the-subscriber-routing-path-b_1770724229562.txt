Here‚Äôs a focused audit of the subscriber routing path based on the current repo state, plus the most likely failure points and what I need from you to pinpoint the root cause.

---

## ‚úÖ What the code **does** today (routing path checkpoints)

### 1) Routing entry + security note (subscriber key path)
Subscriber routing intentionally uses **legacy encrypted agent keys** (not UMK) because subscribers have no active session during webhook handling.

```typescript name=server/routes.ts url=https://github.com/kynomatix/QuantumVault/blob/e7733db61d54818e0d94a03be65406ec51ca1dda/server/routes.ts#L716-L822
// PHASE 6.2 SECURITY NOTE: Subscriber Routing uses LEGACY encrypted key path
// This is INTENTIONAL because subscriber wallets belong to DIFFERENT users who do not have
// active sessions during webhook processing. The source bot's owner has an active session,
// but subscriber bot owners are different users whose UMK is not available.
// Subscriber wallets must use the encrypted agent key stored in the database.
// Future enhancement: Subscribers could enable their own execution authorization for v3 path.
async function routeSignalToSubscribers(
  sourceBotId: string,
  signal: {
    action: 'buy' | 'sell';
    contracts: string;
    positionSize: string;
    price: string;
    isCloseSignal: boolean;
    strategyPositionSize: string | null;
  }
): Promise<void> {
  try {
    console.log(`[Subscriber Routing] Starting routing for source bot ${sourceBotId}, signal: ${signal.action}, close=${signal.isCloseSignal}`);
    
    const publishedBot = await storage.getPublishedBotByTradingBotId(sourceBotId);
    if (!publishedBot) {
      console.log(`[Subscriber Routing] Source bot ${sourceBotId} is not published - skipping routing`);
      return;
    }
    if (!publishedBot.isActive) {
      console.log(`[Subscriber Routing] Published bot ${publishedBot.id} (${publishedBot.name}) is not active - skipping routing`);
      return;
    }
    console.log(`[Subscriber Routing] Found published bot: ${publishedBot.id} (${publishedBot.name}), active=${publishedBot.isActive}`);

    const subscriberBots = await storage.getSubscriberBotsBySourceId(publishedBot.id);
    if (!subscriberBots || subscriberBots.length === 0) {
      console.log(`[Subscriber Routing] No active subscriber bots found for published bot ${publishedBot.id} - skipping routing`);
      return;
    }

    console.log(`[Subscriber Routing] Routing ${signal.action} (close=${signal.isCloseSignal}) to ${subscriberBots.length} subscribers IN PARALLEL`);
```

### 2) Subscriber bot validation + failure tagging
Missing wallet or agent keys **creates failed trades** with `failReason` (so you can query `bot_trades` to see why).

```typescript name=server/routes.ts url=https://github.com/kynomatix/QuantumVault/blob/e7733db61d54818e0d94a03be65406ec51ca1dda/server/routes.ts#L768-L804
const subWallet = await storage.getWallet(subBot.walletAddress);
console.log(`[Subscriber Routing] Wallet lookup for ${subBot.walletAddress}: found=${!!subWallet}, hasAgentKey=${!!subWallet?.agentPublicKey}`);
if (!subWallet) {
  await storage.createBotTrade({
    tradingBotId: subBot.id,
    walletAddress: subBot.walletAddress,
    market: subBot.market,
    side: signal.action === 'buy' ? 'LONG' : 'SHORT',
    size: '0',
    price: signal.price,
    status: 'failed',
    fee: '0',
    errorMessage: 'Wallet not found in database',
    webhookPayload: { source: 'marketplace_routing', signalFrom: sourceBotId, failReason: 'wallet_not_found' },
    executionMethod: 'legacy',
  });
  return 'tradeFailed';
}
if (!subWallet.agentPrivateKeyEncrypted || !subWallet.agentPublicKey) {
  await storage.createBotTrade({
    tradingBotId: subBot.id,
    walletAddress: subBot.walletAddress,
    market: subBot.market,
    side: signal.action === 'buy' ? 'LONG' : 'SHORT',
    size: '0',
    price: signal.price,
    status: 'failed',
    fee: '0',
    errorMessage: 'No agent wallet configured for trading',
    webhookPayload: { source: 'marketplace_routing', signalFrom: sourceBotId, failReason: 'no_agent_keys' },
    executionMethod: 'legacy',
  });
  return 'tradeFailed';
}
```

### 3) Retry path **does** route on success
If source trades were failing and later retried, the retry worker will route to subscribers.

```typescript name=server/trade-retry-service.ts url=https://github.com/kynomatix/QuantumVault/blob/e7733db61d54818e0d94a03be65406ec51ca1dda/server/trade-retry-service.ts#L538-L563
// ROUTING: Route signal to subscribers after successful source bot trade
// This is critical for the marketplace feature - subscribers need to copy the trade
// Routes both OPEN (long/short) and CLOSE signals
if (routingCallback && job.webhookPayload) {
  try {
    const payload = job.webhookPayload as { action?: string; contracts?: string | number; market?: string; positionSize?: string | number };
    const isCloseSignal = job.side === 'close';
    if (payload.action && (payload.contracts !== undefined || isCloseSignal)) {
      console.log(`[TradeRetry] Routing ${isCloseSignal ? 'CLOSE' : 'OPEN'} signal to subscribers for source bot ${job.botId}: ${payload.action}`);
      await routingCallback(job.botId, {
        action: payload.action as 'buy' | 'sell',
        contracts: isCloseSignal ? '0' : String(payload.contracts),
        positionSize: String(payload.positionSize ?? '100'),
        price: String(fillPrice),
        isCloseSignal,
        strategyPositionSize: null,
      });
      console.log(`[TradeRetry] Routing completed for bot ${job.botId}`);
    } else {
      console.log(`[TradeRetry] Skipping routing: incomplete webhook payload (action=${payload.action}, contracts=${payload.contracts})`);
    }
  } catch (routingErr: any) {
    console.error(`[TradeRetry] Routing to subscribers failed (non-blocking): ${routingErr.message}`);
  }
} else if (!routingCallback) {
  console.warn(`[TradeRetry] Routing callback not registered - subscribers may not receive signal for bot ${job.botId}`);
}
```

---

## üîé Likely failure points (based on current logic)

1) **`published_bots.isActive` = false**  
   Routing exits early. This can happen even if subscriptions exist.

2) **`getSubscriberBotsBySourceId()` returns empty**  
   Usually means:
   - No `bot_subscriptions` in `active` status
   - `subscriberBotId` missing or null
   - Sub-bot wasn‚Äôt created correctly

3) **Subscriber wallet has no agent keys**  
   You‚Äôll see `failReason: no_agent_keys` in `bot_trades.webhookPayload`.

4) **Sizing guard auto-pauses**  
   `computeTradeSizingAndTopUp()` returns `shouldPauseBot` when collateral below min.  
   That generates failed trades with `failReason: sizing_failed` or similar (need to confirm exact error).

---

## ‚úÖ Immediate triage I need from you

Please grab **any one failed subscriber trade** from `bot_trades` and send:

- `tradingBotId`
- `status`
- `errorMessage`
- `webhookPayload` (especially `failReason`)
- `executedAt`
- if possible, the surrounding server logs for:
  - `[Subscriber Routing] SUMMARY`
  - `[Subscriber Routing] AUDIT`

Also confirm:
- `published_bots.isActive` for the source bot
- `bot_subscriptions.status` for at least one subscriber
- `trading_bots.isActive` for a subscriber bot

---

## ‚úÖ Optional: run built-in routing diagnostics (from docs)

The repo includes a subscriber diagnostics doc with trace points and admin endpoints. If you can run them, they‚Äôre tailored to this exact problem.

```markdown name=docs/SUBSCRIBER_DIAGNOSTICS.md url=https://github.com/kynomatix/QuantumVault/blob/e7733db61d54818e0d94a03be65406ec51ca1dda/docs/SUBSCRIBER_DIAGNOSTICS.md#L18-L88
| Paused bot routing | Source bot is paused but published | Webhook handler, bot-active check |
| Execution disabled routing | Source wallet execution auth disabled but published | Webhook handler, executionEnabled check |
| Execution expired routing | Source wallet execution auth expired but published | Webhook handler, executionExpiresAt check |
| Close signal deferred | Successful close trade execution | After close response sent |
| Open signal deferred | Successful open trade execution | After open response sent |
| Retry callback | Successful retry execution | `trade-retry-service.ts` |
```

---

## ‚ö†Ô∏è Code search note
I used code search to locate routing diagnostics and callback wiring. **Search results are limited to 10 entries and may be incomplete.**  
You can view more results here:

https://github.com/search?q=repo%3Akynomatix%2FQuantumVault+routeSignalToSubscribers&type=code

---

## Next step
Send me **one concrete failed subscriber trade record** + the related logs and I‚Äôll do a pinpointed, line-level root-cause report (and propose fixes if needed).